---
version: '3.8'

x-rpmbuild:
  dist: &rpmbuild_dist '.el7'
  channel_name: &rpmbuild_channel stable
  email: &rpmbuild_email "foundationgeoint-packaging@maxar.com"
  packager_name: &rpmbuild_name "FoundationGEOINT Packaging"
  postgres_version: &postgres_version '13'
  vendor: &rpmbuild_vendor "Maxar Technologies"
  base_args: &rpmbuild_base_args
    rpmbuild_dist: *rpmbuild_dist
    rpmbuild_email: *rpmbuild_email
    rpmbuild_name: *rpmbuild_name
    rpmbuild_uid: "${RPMBUILD_UID}"
    rpmbuild_gid: "${RPMBUILD_GID}"
  build_defaults: &build_defaults
    context: .
    dockerfile: docker/Dockerfile.rpmbuild-generic
    labels:
      maintainer: *rpmbuild_email
      vendor: *rpmbuild_vendor
  # Use consistent values for minimum versions for RPM build
  # and runtime requirements.
  minimum_versions:
    geos: &geos_min_version '3.9.0'
    gdal: &gdal_min_version '3.2.0'
    libosmium: &libosmium_min_version '2.16.0'
    postgis_min_version: &postgis_min_version '3.1.0'
    proj: &proj_min_version '7.2.0'
    protobuf: &protobuf_min_version '3.0.0'
    protobuf-c: &protobuf_c_min_version '1.3.0'
    protozero: &protozero_min_version '1.7.0'
    sqlite_min_version: &sqlite_min_version '3.11.0'
  # Configuration for building every dependency RPM.
  rpms:
    CGAL:
      image: rpmbuild-cgal
      version: &CGAL_version '4.14.3-1'
    FileGDBAPI:
      image: rpmbuild-generic
      version: &FileGDBAPI_version '1.5.1-1'
    SFCGAL:
      image: rpmbuild-sfcgal
      version: &SFCGAL_version '1.3.9-1'
    gdal:
      image: rpmbuild-gdal
      version: &gdal_version '3.2.1-1'
      defines:
        geos_min_version: *geos_min_version
        proj_min_version: *proj_min_version
    geos:
      image: rpmbuild-geos
      version: &geos_version '3.9.1-1'
    gpsbabel:
      image: rpmbuild-gpsbabel
      version: &gpsbabel_version '1.7.0-1'
    google-noto-fonts-extra:
      image: rpmbuild-fonts
      version: &google-noto-fonts-extra_version '20210210-1'
      defines:
        commit: '0c0b4f8660099c9cda5db230f9ce38733089a2a9'
      arch: noarch
    hanazono-fonts:
      image: rpmbuild-fonts
      version: &hanazono-fonts_version '20170904-1'
      arch: noarch
    libgeotiff:
      image: rpmbuild-libgeotiff
      version: &libgeotiff_version '1.6.0-1'
      defines:
        proj_min_version: *proj_min_version
    libkml:
      image: rpmbuild-libkml
      version: &libkml_version '1.3.0-1'
    libosmium:
      image: rpmbuild-libosmium
      version: &libosmium_version '2.16.0-1'
      arch: noarch
      name: libosmium-devel
      defines:
        protozero_min_version: *protozero_min_version
    mapnik:
      image: rpmbuild-mapnik
      version: &mapnik_version '3.0.23-1'
      defines:
        geos_min_version: *geos_min_version
        postgis_min_version: *postgis_min_version
        proj_min_version: *proj_min_version
    osmctools:
      image: rpmbuild-osmctools
      version: &osmctools_version '0.9-1'
    osmosis:
      image: rpmbuild-generic
      version: &osmosis_version '0.48.3-1'
      arch: noarch
    osmium-tool:
      image: rpmbuild-osmium-tool
      version: &osmium-tool_version '1.13.1-1'
      defines:
        libosmium_min_version: *libosmium_min_version
        protozero_min_version: *protozero_min_version
    osm2pgsql:
      image: rpmbuild-osm2pgsql
      version: &osm2pgsql_version '1.4.1-1'
      defines:
        libosmium_min_version: *libosmium_min_version
        proj_min_version: *proj_min_version
        postgis_min_version: *postgis_min_version
        protobuf_c_min_version: *protobuf_c_min_version
    rack:
      image: rpmbuild-rack
      version: &rack_version '2.2.3-1'
      arch: noarch
      name: rubygem-rack
      spec_file: 'SPECS/rubygem-rack.spec'
    sbt:
      image: rpmbuild-generic
      version: &sbt_version '1.4.7-1'
      arch: noarch
    passenger:
      image: rpmbuild-passenger
      version: &passenger_version '6.0.7-1'
    postgis:
      image: rpmbuild-postgis
      version: &postgis_version '3.1.1-1'
      defines:
        gdal_min_version: *gdal_min_version
        geos_min_version: *geos_min_version
        proj_min_version: *proj_min_version
        protobuf_min_version: *protobuf_min_version
        protobuf_c_min_version: *protobuf_c_min_version
    proj:
      image: rpmbuild-proj
      version: &proj_version '7.2.1-1'
      defines:
        data_version: '1.4'
        sqlite_min_version: *sqlite_min_version
    proj6:
      image: rpmbuild-proj
      version: &proj6_version '6.3.2-1'
      name: proj
    protobuf:
      image: rpmbuild-protobuf
      version: &protobuf_version '3.15.1-1'
    protobuf-c:
      image: rpmbuild-protobuf-c
      version: &protobuf-c_version '1.3.3-1'
      defines:
        protobuf_c_min_version: *protobuf_c_min_version
    protozero:
      image: rpmbuild-protozero
      version: &protozero_version '1.7.0-1'
      arch: noarch
      name: protozero-devel
      defines:
        protobuf_min_version: *protobuf_min_version
    python3-osmium:
      image: rpmbuild-pyosmium
      version: &pyosmium_version '3.1.3-1'
      defines:
        libosmium_min_version: *libosmium_min_version
        protozero_min_version: *protozero_min_version
        pybind11_version: '2.6.2'
    ruby:
      image: rpmbuild-ruby
      version: &ruby_version '2.7.2-1'
      defines: &ruby_bundled_versions
        bundler_version: '2.1.4'
        bundler_connection_pool_version: '2.2.2'
        bundler_fileutils_version: '1.3.0'
        bundler_molinillo_version: '0.6.6'
        bundler_net_http_persistent_version: '3.1.0'
        bundler_thor_version: '1.0.0'
        bigdecimal_version: '2.0.0'
        did_you_mean_version: '1.4.0'
        io_console_version: '0.5.6'
        irb_version: '1.2.6'
        json_version: '2.3.0'
        minitest_version: '5.13.0'
        net_telnet_version: '0.2.0'
        openssl_version: '2.1.2'
        power_assert_version: '1.1.7'
        psych_version: '3.1.0'
        racc_version: '1.4.16'
        rake_version: '13.0.1'
        rdoc_version: '6.2.1'
        rubygems_version: '3.1.4'
        rubygems_molinillo_version: '0.5.7'
        test_unit_version: '3.3.4'
        xmlrpc_version: '0.3.0'
    sqlite:
      image: rpmbuild-sqlite
      version: &sqlite_version '3.34.1-1'
  service_volumes: &service_volumes
    - "./RPMS:/rpmbuild/RPMS:rw"
    - "./SOURCES:/rpmbuild/SOURCES:rw"
    - "./SPECS:/rpmbuild/SPECS:ro"
    - "./scripts:/rpmbuild/scripts:ro"
  service_defaults: &service_defaults
    command: 'tail -f /dev/null'
    init: true
    volumes: *service_volumes

services:
  rpmbuild:
    build:
      context: .
      dockerfile: docker/Dockerfile.rpmbuild
      args:
        <<: *rpmbuild_base_args
      labels:
        maintainer: *rpmbuild_email
        vendor: *rpmbuild_vendor
    command: 'tail -f /dev/null'
    init: true
    user: nobody
  rpmbuild-generic:
    <<: *service_defaults
    depends_on:
      - rpmbuild
    build:
      <<: *build_defaults
      args:
        rpmbuild_channel: *rpmbuild_channel
  rpmbuild-cgal:
    <<: *service_defaults
    depends_on:
      - rpmbuild-generic
    build:
      <<: *build_defaults
      args:
        packages: "${RPMBUILD_CGAL_PACKAGES}"
        rpmbuild_channel: *rpmbuild_channel
  rpmbuild-fonts:
    <<: *service_defaults
    depends_on:
      - rpmbuild-generic
    build:
      <<: *build_defaults
      args:
        packages: 'fontpackages-devel git python3 python3-pip'
        rpmbuild_channel: *rpmbuild_channel
  rpmbuild-gdal:
    <<: *service_defaults
    depends_on:
      - rpmbuild-pgdg
    build:
      <<: *build_defaults
      args:
        packages: "${RPMBUILD_GDAL_PACKAGES}"
        rpmbuild_channel: *rpmbuild_channel
        cgal_version: *CGAL_version
        filegdbapi_version: *FileGDBAPI_version
        geos_version: *geos_version
        gpsbabel_version: *gpsbabel_version
        libgeotiff_version: *libgeotiff_version
        libkml_version: *libkml_version
        proj_version: *proj_version
        sfcgal_version: *SFCGAL_version
        sqlite_version: *sqlite_version
      dockerfile: docker/Dockerfile.rpmbuild-gdal
  rpmbuild-geos:
    <<: *service_defaults
    depends_on:
      - rpmbuild-generic
    build:
      <<: *build_defaults
      args:
        packages: "${RPMBUILD_GEOS_PACKAGES}"
        rpmbuild_channel: *rpmbuild_channel
  rpmbuild-gpsbabel:
    <<: *service_defaults
    depends_on:
      - rpmbuild-generic
    build:
      <<: *build_defaults
      args:
        packages: "${RPMBUILD_GPSBABEL_PACKAGES}"
        rpmbuild_channel: *rpmbuild_channel
  rpmbuild-proj:
    <<: *service_defaults
    depends_on:
      - rpmbuild-sqlite
    build:
      <<: *build_defaults
      args:
        packages: "${RPMBUILD_PROJ_PACKAGES}"
        rpmbuild_channel: *rpmbuild_channel
        sqlite_version: *sqlite_version
      dockerfile: docker/Dockerfile.rpmbuild-proj
  rpmbuild-protobuf:
    <<: *service_defaults
    depends_on:
      - rpmbuild-generic
    build:
      <<: *build_defaults
      args:
        packages: "${RPMBUILD_PROTOBUF_PACKAGES}"
        rpmbuild_channel: *rpmbuild_channel
  rpmbuild-protobuf-c:
    <<: *service_defaults
    depends_on:
      - rpmbuild-protobuf
    build:
      <<: *build_defaults
      args:
        packages: "${RPMBUILD_PROTOBUF_C_PACKAGES}"
        protobuf_version: *protobuf_version
        rpmbuild_channel: *rpmbuild_channel
      dockerfile: docker/Dockerfile.rpmbuild-protobuf-c
  rpmbuild-libgeotiff:
    <<: *service_defaults
    depends_on:
      - rpmbuild-proj
    build:
      <<: *build_defaults
      args:
        packages: "${RPMBUILD_LIBGEOTIFF_PACKAGES}"
        rpmbuild_channel: *rpmbuild_channel
        proj_version: *proj_version
      dockerfile: docker/Dockerfile.rpmbuild-libgeotiff
  rpmbuild-libkml:
    <<: *service_defaults
    depends_on:
      - rpmbuild-generic
    build:
      <<: *build_defaults
      args:
        packages: "${RPMBUILD_LIBKML_PACKAGES}"
        rpmbuild_channel: *rpmbuild_channel
  rpmbuild-libosmium:
    <<: *service_defaults
    depends_on:
      - rpmbuild-protozero
    build:
      <<: *build_defaults
      args:
        packages: "${RPMBUILD_LIBOSMIUM_PACKAGES}"
        protozero_version: *protozero_version
        rpmbuild_channel: *rpmbuild_channel
      dockerfile: docker/Dockerfile.rpmbuild-libosmium
  rpmbuild-mapnik:
    <<: *service_defaults
    depends_on:
      - rpmbuild-postgis
    build:
      <<: *build_defaults
      args:
        cgal_version: *CGAL_version
        filegdbapi_version: *FileGDBAPI_version
        gdal_version: *gdal_version
        geos_version: *geos_version
        gpsbabel_version: *gpsbabel_version
        libgeotiff_version: *libgeotiff_version
        libkml_version: *libkml_version
        packages: "${RPMBUILD_MAPNIK_PACKAGES}"
        postgis_version: *postgis_version
        proj_version: *proj_version
        protobuf_version: *protobuf_version
        protobuf_c_version: *protobuf-c_version
        rpmbuild_channel: *rpmbuild_channel
        sfcgal_version: *SFCGAL_version
        sqlite_version: *sqlite_version
      dockerfile: docker/Dockerfile.rpmbuild-postgis-generic
  rpmbuild-osmctools:
    <<: *service_defaults
    depends_on:
      - rpmbuild-generic
    build:
      <<: *build_defaults
      args:
        packages: "${RPMBUILD_OSMCTOOLS_PACKAGES}"
        rpmbuild_channel: *rpmbuild_channel
  rpmbuild-osmium-tool:
    <<: *service_defaults
    depends_on:
      - rpmbuild-libosmium
    build:
      <<: *build_defaults
      args:
        libosmium_version: *libosmium_version
        packages: "${RPMBUILD_OSMIUM_TOOL_PACKAGES}"
        protozero_version: *protozero_version
        rpmbuild_channel: *rpmbuild_channel
      dockerfile: docker/Dockerfile.rpmbuild-libosmium-generic
  rpmbuild-osm2pgsql:
    <<: *service_defaults
    depends_on:
      - rpmbuild-libosmium
      - rpmbuild-postgis
    build:
      <<: *build_defaults
      args:
        cgal_version: *CGAL_version
        filegdbapi_version: *FileGDBAPI_version
        gdal_version: *gdal_version
        geos_version: *geos_version
        gpsbabel_version: *gpsbabel_version
        libgeotiff_version: *libgeotiff_version
        libkml_version: *libkml_version
        libosmium_version: *libosmium_version
        packages: "${RPMBUILD_OSM2PGSQL_PACKAGES}"
        postgis_version: *postgis_version
        proj_version: *proj_version
        protobuf_version: *protobuf_version
        protobuf_c_version: *protobuf-c_version
        protozero_version: *protozero_version
        rpmbuild_channel: *rpmbuild_channel
        sfcgal_version: *SFCGAL_version
        sqlite_version: *sqlite_version
        rpmbuild_channel: *rpmbuild_channel
      dockerfile: docker/Dockerfile.rpmbuild-osm2pgsql
  rpmbuild-passenger:
    <<: *service_defaults
    depends_on:
      - rpmbuild-rack
    build:
      <<: *build_defaults
      args:
        <<: *ruby_bundled_versions
        packages: "${RPMBUILD_PASSENGER_PACKAGES}"
        rpmbuild_channel: *rpmbuild_channel
        rack_version: *rack_version
        ruby_version: *ruby_version
      dockerfile: docker/Dockerfile.rpmbuild-passenger
  rpmbuild-pgdg:
    <<: *service_defaults
    depends_on:
      - rpmbuild
    build:
      <<: *build_defaults
      args:
        postgres_version: *postgres_version
        rpmbuild_channel: *rpmbuild_channel
      dockerfile: docker/Dockerfile.rpmbuild-pgdg
  rpmbuild-postgis:
    <<: *service_defaults
    depends_on:
      - rpmbuild-gdal
      - rpmbuild-protobuf-c
    build:
      <<: *build_defaults
      args:
        cgal_version: *CGAL_version
        filegdbapi_version: *FileGDBAPI_version
        gdal_version: *gdal_version
        geos_version: *geos_version
        gpsbabel_version: *gpsbabel_version
        libgeotiff_version: *libgeotiff_version
        libkml_version: *libkml_version
        packages: "${RPMBUILD_POSTGIS_PACKAGES}"
        proj_version: *proj_version
        protobuf_version: *protobuf_version
        protobuf_c_version: *protobuf-c_version
        rpmbuild_channel: *rpmbuild_channel
        sfcgal_version: *SFCGAL_version
        sqlite_version: *sqlite_version
      dockerfile: docker/Dockerfile.rpmbuild-postgis
  rpmbuild-protozero:
    <<: *service_defaults
    depends_on:
      - rpmbuild-protobuf
    build:
      <<: *build_defaults
      args:
        packages: "${RPMBUILD_PROTOZERO_PACKAGES}"
        protobuf_version: *protobuf_version
        rpmbuild_channel: *rpmbuild_channel
      dockerfile: docker/Dockerfile.rpmbuild-protozero
  rpmbuild-pyosmium:
    <<: *service_defaults
    depends_on:
      - rpmbuild-libosmium
    build:
      <<: *build_defaults
      args:
        libosmium_version: *libosmium_version
        protozero_version: *protozero_version
        packages: "${RPMBUILD_PYOSMIUM_PACKAGES}"
        protobuf_version: *protobuf_version
        rpmbuild_channel: *rpmbuild_channel
      dockerfile: docker/Dockerfile.rpmbuild-libosmium-generic
  rpmbuild-rack:
    <<: *service_defaults
    depends_on:
      - rpmbuild-ruby
    build:
      <<: *build_defaults
      args:
        <<: *ruby_bundled_versions
        gem_packages: 'fcgi minitest minitest-sprint minitest-global_expectations thin'
        packages: "${RPMBUILD_RACK_PACKAGES}"
        rpmbuild_channel: *rpmbuild_channel
        ruby_version: *ruby_version
      dockerfile: docker/Dockerfile.rpmbuild-rubygems
  rpmbuild-ruby:
    <<: *service_defaults
    depends_on:
      - rpmbuild-generic
    build:
      <<: *build_defaults
      args:
        packages: "${RPMBUILD_RUBY_PACKAGES}"
        rpmbuild_channel: *rpmbuild_channel
  rpmbuild-sfcgal:
    <<: *service_defaults
    depends_on:
      - rpmbuild-cgal
    build:
      <<: *build_defaults
      args:
        cgal_version: *CGAL_version
        packages: "${RPMBUILD_SFCGAL_PACKAGES}"
        rpmbuild_channel: *rpmbuild_channel
      dockerfile: docker/Dockerfile.rpmbuild-sfcgal
  rpmbuild-sqlite:
    <<: *service_defaults
    depends_on:
      - rpmbuild-generic
    build:
      <<: *build_defaults
      args:
        packages: "${RPMBUILD_SQLITE_PACKAGES}"
        rpmbuild_channel: *rpmbuild_channel
